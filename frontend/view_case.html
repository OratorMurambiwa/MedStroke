<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Case - Stroke Detection System</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000000;
      color: #FFFFFF;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header-bar {
      background-color: #F5F5DC; /* Cream background */
      border-bottom: 3px solid #FDB927; /* Gold bottom border */
      color: #000000; /* Dark text */
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .system-name {
      font-size: 24px;
      font-weight: bold;
      color: #000000;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .theme-toggle {
      background-color: #FDB927;
      color: #000000;
      font-weight: bold;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .theme-toggle:hover {
      background-color: #d4a218;
    }

    .logout-btn {
      background-color: #FDB927;
      color: #000000;
      font-weight: bold;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .logout-btn:hover {
      background-color: #d4a218;
    }

    /* Dark theme styles */
    body.dark-theme {
      background-color: #1a1a1a;
      color: #FFFFFF;
    }

    body.dark-theme .header-bar {
      background-color: #2d2d2d;
      color: #FFFFFF;
    }

    body.dark-theme .system-name {
      color: #FFFFFF;
    }

    .main-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }

    .case-container {
      width: 100%;
      max-width: 1200px;
      background-color: #FFFFFF;
      color: #000000;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .case-header {
      background-color: #FDB927;
      color: #000000;
      padding: 20px 30px;
      border-bottom: 3px solid #d4a218;
    }

    .case-title {
      font-size: 28px;
      font-weight: bold;
      margin: 0 0 10px 0;
    }

    .case-subtitle {
      font-size: 16px;
      opacity: 0.8;
      margin: 0;
    }

    .case-body {
      padding: 30px;
    }

    .section {
      margin-bottom: 40px;
      padding: 25px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 5px solid #FDB927;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #FDB927;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-icon {
      font-size: 24px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .vitals-table {
      width: 100%;
      border-collapse: collapse;
      background-color: #FFFFFF;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .vitals-table th {
      background-color: #FDB927;
      color: #000000;
      padding: 15px 12px;
      text-align: left;
      font-weight: bold;
      font-size: 14px;
    }

    .vitals-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .vitals-table tr:hover {
      background-color: #f8f9fa;
    }

    .nihss-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .nihss-item {
      background-color: #FFFFFF;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #FDB927;
    }

    .nihss-label {
      font-weight: 600;
      color: #666;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .nihss-score {
      font-size: 24px;
      font-weight: bold;
      color: #FDB927;
    }

    .nihss-total {
      background-color: #FDB927;
      color: #000000;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
    }

    .nihss-total-score {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .nihss-severity {
      font-size: 18px;
      font-weight: 600;
    }

    .scan-container {
      display: flex;
      gap: 30px;
      align-items: flex-start;
    }

    .scan-image {
      flex: 1;
      max-width: 400px;
    }

    .scan-image img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .scan-info {
      flex: 1;
    }

    .imaging-confirmed {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
      margin-top: 10px;
    }

    .imaging-confirmed.yes {
      background-color: #4CAF50;
      color: white;
    }

    .imaging-confirmed.no {
      background-color: #F44336;
      color: white;
    }

    .eligibility-result {
      background-color: #FFFFFF;
      padding: 20px;
      border-radius: 8px;
      border-left: 5px solid #4CAF50;
    }

    .eligibility-result.not-eligible {
      border-left-color: #F44336;
    }

    .eligibility-status {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .eligibility-status.eligible {
      color: #4CAF50;
    }

    .eligibility-status.not-eligible {
      color: #F44336;
    }

    .notes-textarea {
      width: 100%;
      min-height: 100px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    .notes-textarea:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.2);
    }

    .readonly-textarea {
      background-color: #f8f9fa;
      color: #666;
      cursor: not-allowed;
    }

    .icd-search-container {
      position: relative;
      margin-bottom: 20px;
    }

    .icd-search-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    .icd-search-input:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.2);
    }

    .icd-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #FFFFFF;
      border: 2px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .icd-result-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .icd-result-item:hover {
      background-color: #f8f9fa;
    }

    .icd-code {
      font-weight: bold;
      color: #FDB927;
    }

    .icd-description {
      color: #666;
      font-size: 14px;
    }

    .icd-group-header {
      background-color: #FDB927;
      color: #000000;
      padding: 8px 15px;
      font-weight: bold;
      font-size: 13px;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .icd-loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .icd-error {
      text-align: center;
      padding: 20px;
      color: #F44336;
      font-size: 14px;
    }

    .selected-diagnosis {
      background-color: #e8f5e8;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #4CAF50;
      margin-bottom: 20px;
    }

    .treatment-plan {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    .treatment-plan:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.2);
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #eee;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 150px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-approve {
      background-color: #4CAF50;
      color: white;
    }

    .btn-approve:hover {
      background-color: #45a049;
    }

    .btn-reject {
      background-color: #F44336;
      color: white;
    }

    .btn-reject:hover {
      background-color: #da190b;
    }

    .btn-request-update {
      background-color: #FF9800;
      color: white;
    }

    .btn-request-update:hover {
      background-color: #e68900;
    }

    .btn-save {
      background-color: #FDB927;
      color: #000000;
    }

    .btn-save:hover {
      background-color: #d4a218;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      max-width: 400px;
    }

    .toast {
      background-color: #333;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background-color: #4CAF50;
    }

    .toast.error {
      background-color: #F44336;
    }

    .toast.warning {
      background-color: #FF9800;
    }

    .toast.info {
      background-color: #2196F3;
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
      opacity: 0.7;
    }

    .toast-close:hover {
      opacity: 1;
    }

    /* Loading Spinner Styles */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .loading-spinner .spinner {
      border-color: rgba(102, 102, 102, 0.3);
      border-top-color: #666;
    }

    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid #F44336;
      margin-bottom: 20px;
    }

    /* Dark theme for case content */
    body.dark-theme .case-container {
      background-color: #2d2d2d;
      color: #FFFFFF;
    }

    body.dark-theme .section {
      background-color: #3d3d3d;
    }

    body.dark-theme .info-label {
      color: #CCCCCC;
    }

    body.dark-theme .info-value {
      color: #FFFFFF;
    }

    body.dark-theme .vitals-table {
      background-color: #2d2d2d;
    }

    body.dark-theme .vitals-table td {
      color: #FFFFFF;
      border-bottom-color: #444;
    }

    body.dark-theme .vitals-table tr:hover {
      background-color: #3d3d3d;
    }

    body.dark-theme .nihss-item {
      background-color: #2d2d2d;
    }

    body.dark-theme .nihss-label {
      color: #CCCCCC;
    }

    body.dark-theme .eligibility-result {
      background-color: #2d2d2d;
    }

    body.dark-theme .notes-textarea,
    body.dark-theme .treatment-plan {
      background-color: #2d2d2d;
      color: #FFFFFF;
      border-color: #555;
    }

    body.dark-theme .icd-search-input {
      background-color: #2d2d2d;
      color: #FFFFFF;
      border-color: #555;
    }

    body.dark-theme .icd-results {
      background-color: #2d2d2d;
      border-color: #555;
    }

    body.dark-theme .icd-result-item {
      color: #FFFFFF;
      border-bottom-color: #444;
    }

    body.dark-theme .icd-result-item:hover {
      background-color: #3d3d3d;
    }

    body.dark-theme .icd-group-header {
      background-color: #FDB927;
      color: #000000;
      border-bottom-color: #555;
    }

    body.dark-theme .icd-loading {
      color: #CCCCCC;
    }

    body.dark-theme .icd-error {
      color: #FF6B6B;
    }

    body.dark-theme .selected-diagnosis {
      background-color: #1b5e20;
      border-color: #4CAF50;
      color: #FFFFFF;
    }

    body.dark-theme .readonly-textarea {
      background-color: #3d3d3d;
      color: #CCCCCC;
    }

    /* Dark theme for AI Treatment Generator */
    body.dark-theme .section .info-label {
      color: #CCCCCC;
    }

    body.dark-theme .section .info-value {
      color: #FFFFFF;
    }

    /* Dark theme for toast notifications */
    body.dark-theme .toast {
      background-color: #2d2d2d;
      color: #FFFFFF;
      border: 1px solid #444;
    }

    body.dark-theme .toast.success {
      background-color: #2e7d32;
    }

    body.dark-theme .toast.error {
      background-color: #c62828;
    }

    body.dark-theme .toast.warning {
      background-color: #ef6c00;
    }

    body.dark-theme .toast.info {
      background-color: #1565c0;
    }

    body.dark-theme .loading-spinner {
      color: #CCCCCC;
    }

    body.dark-theme .loading-spinner .spinner {
      border-color: rgba(204, 204, 204, 0.3);
      border-top-color: #CCCCCC;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="header-left">
      <div class="system-name">Stroke Detection System</div>
    </div>
    
    <div class="header-right">
      <button class="theme-toggle" onclick="toggleTheme()" title="üåô Theme Toggle - Light/Dark comfort mode">
        üåô Theme
      </button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main-content">
    <div class="case-container">
      <div class="case-header">
        <h1 class="case-title">Case Review</h1>
        <p class="case-subtitle" id="caseSubtitle">Loading case details...</p>
      </div>
      
      <div class="case-body">
        <div id="loadingMessage" class="loading">
          <h3>Loading case details...</h3>
          <p>Please wait while we fetch the patient information.</p>
        </div>

        <div id="errorMessage" class="error" style="display: none;">
          <h3>Error Loading Case</h3>
          <p id="errorText">Unable to load case details. Please try again.</p>
        </div>

        <div id="caseContent" style="display: none;">
          <!-- Patient Info Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üë§</span>
              Patient Information
            </h2>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Patient Name</div>
                <div class="info-value" id="patientName">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Age</div>
                <div class="info-value" id="patientAge">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Gender</div>
                <div class="info-value" id="patientGender">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Time Since Onset</div>
                <div class="info-value" id="timeSinceOnset">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Consent Status</div>
                <div class="info-value" id="consentStatus">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Chief Complaint</div>
                <div class="info-value" id="chiefComplaint">-</div>
              </div>
            </div>
          </div>

          <!-- Vitals Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üíì</span>
              Vital Signs
            </h2>
            <table class="vitals-table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Value</th>
                  <th>Unit</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="vitalsTableBody">
                <tr><td colspan="4" style="text-align: center;">Loading vitals...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- NIHSS Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üß†</span>
              NIHSS Assessment
            </h2>
            <div class="nihss-grid" id="nihssGrid">
              <div class="loading">Loading NIHSS scores...</div>
            </div>
            <div class="nihss-total">
              <div class="nihss-total-score" id="nihssTotal">-</div>
              <div class="nihss-severity" id="nihssSeverity">-</div>
            </div>
          </div>

          <!-- Scan Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üì∑</span>
              Imaging Scan
            </h2>
            <div class="scan-container">
              <div class="scan-image">
                <img id="scanImage" src="" alt="Brain scan image" style="display: none;">
                <div id="noImageMessage" style="text-align: center; padding: 40px; color: #666;">
                  No scan image available
                </div>
              </div>
              <div class="scan-info">
                <div class="info-item">
                  <div class="info-label">Scan File</div>
                  <div class="info-value" id="scanFileName">-</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Upload Date</div>
                  <div class="info-value" id="scanUploadDate">-</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Eligibility Result Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">‚úÖ</span>
              Eligibility Assessment
            </h2>
            <div class="eligibility-result" id="eligibilityResult">
              <div class="eligibility-status" id="eligibilityStatus">-</div>
              <div class="info-value" id="eligibilityReason">-</div>
            </div>
          </div>

          <!-- Technician Notes Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üìù</span>
              Technician Notes
            </h2>
            <textarea class="notes-textarea readonly-textarea" id="technicianNotes" readonly>-</textarea>
          </div>



          
          <!-- ICD-10 Diagnosis, AI Suggestion & Treatment Section -->
          <div class="section">
            <h2 class="section-title">
              ICD-10 Diagnosis & Treatment Plan
            </h2>

            <!-- ICD-10 Search -->
            <div class="icd-search-container">
              <input type="text" class="icd-search-input" id="icdSearchInput"
                    placeholder="Search ICD-10 codes (e.g., 'stroke', 'hemorrhage')"
                    onkeyup="searchICD10(this.value)">
              <div class="icd-results" id="icdResults"></div>
            </div>

            <!-- Selected Diagnosis -->
            <div id="selectedDiagnosisContainer" style="display: none;">
              <div class="selected-diagnosis">
                <div class="info-label">Selected Diagnosis</div>
                <div class="info-value" id="selectedDiagnosis">-</div>
              </div>
            </div>

            <!-- Treatment Plan -->
            <div class="info-item" style="margin-bottom: 15px;">
              <div class="info-label">Treatment Plan</div>
              <textarea class="treatment-plan" id="treatmentPlan"
                        placeholder="Enter detailed treatment plan, medications, follow-up instructions..."></textarea>
            </div>

            <!-- Generate AI Treatment Suggestion -->
            <button id="generatePlanBtn" class="btn"
                    style="background-color: #2196F3; color: white; margin-bottom: 15px;"
                    onclick="generateAITreatmentPlan()">
                <span id="generateBtnText">Generate AI Treatment Suggestion</span>
                <span id="generateBtnSpinner" class="spinner" style="display: none;"></span>
            </button>

            <!-- AI Loading Message -->
            <div id="aiLoadingMessage" class="loading-spinner" style="display: none;">
              <div class="spinner"></div>
              <span>Generating AI treatment plan... Please wait.</span>
            </div>

            <!-- Save Button -->
            <button class="btn btn-save" onclick="saveDiagnosis()">Save Diagnosis & Treatment</button>
          </div>


            

          </div>

          <!-- Decision Buttons -->
          <div class="button-group">
            <button class="btn btn-approve" onclick="makeDecision('approved_tpa')">
              Approve tPA Treatment
            </button>
            <button class="btn btn-reject" onclick="makeDecision('rejected')">
              Reject tPA Treatment
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    let currentPatientCode = '';
    let currentScanId = null;
    let selectedICDCode = null;

    // Theme toggle functionality
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
      const isDark = document.body.classList.contains('dark-theme');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Update theme button text
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.innerHTML = isDark ? '‚òÄÔ∏è Theme' : 'üåô Theme';
    }

    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        const themeBtn = document.querySelector('.theme-toggle');
        themeBtn.innerHTML = '‚òÄÔ∏è Theme';
      }
      
      // Get patient code from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentPatientCode = urlParams.get('code');
      
      if (currentPatientCode) {
        loadCaseDetails();
      } else {
        showError('No patient code provided');
      }
      
      // Auto-search for "stroke" to show all stroke-related codes
      setTimeout(() => {
        const searchInput = document.getElementById('icdSearchInput');
        if (searchInput) {
          searchInput.value = 'stroke';
          searchICD10('stroke');
        }
      }, 1000);
    });

    // Logout functionality
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/login-page';
          })
          .catch(() => {
            window.location.href = '/login-page';
          });
      }
    }

    // Load case details
    async function loadCaseDetails() {
      try {
        const response = await fetch(`/api/cases/${currentPatientCode}`);
        if (!response.ok) {
          throw new Error('Case not found');
        }
        
        const caseData = await response.json();
        
        // Populate the form
        populateCaseData(caseData);
        
        // Hide loading, show content
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('caseContent').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading case details:', error);
        showError(error.message);
      }
    }

    // Populate case data
    function populateCaseData(caseData) {
      const patientData = caseData.patient;
      const scanData = caseData.scan;
      const nihssData = caseData.nihss;
      
      // Update header
      document.getElementById('caseSubtitle').textContent = `Patient ${patientData.code} - ${patientData.name}`;
      
      // Patient info
      document.getElementById('patientName').textContent = patientData.name || 'N/A';
      document.getElementById('patientAge').textContent = patientData.age ? `${patientData.age} years` : 'N/A';
      document.getElementById('patientGender').textContent = patientData.gender || 'N/A';
      document.getElementById('timeSinceOnset').textContent = patientData.time_since_onset || 'N/A';
      document.getElementById('consentStatus').textContent = 'Consented'; // Default assumption
      document.getElementById('chiefComplaint').textContent = patientData.chief_complaint || 'N/A';
      
      // Vitals
      populateVitalsTable(patientData);
      
      // NIHSS
      if (nihssData) {
        populateNIHSS(nihssData);
      } else {
        document.getElementById('nihssGrid').innerHTML = '<div style="text-align: center; color: #666;">NIHSS assessment not completed</div>';
        document.getElementById('nihssTotal').textContent = 'N/A';
        document.getElementById('nihssSeverity').textContent = 'Assessment Required';
      }
      
      // Scan data
      if (scanData) {
        currentScanId = scanData.id;
        
        // Scan image
        if (scanData.image_path) {
          document.getElementById('scanImage').src = scanData.image_path;
          document.getElementById('scanImage').style.display = 'block';
          document.getElementById('noImageMessage').style.display = 'none';
        }
        
        document.getElementById('scanFileName').textContent = scanData.image_path ? scanData.image_path.split('/').pop() : 'N/A';
        document.getElementById('scanUploadDate').textContent = scanData.timestamp || 'N/A';
       
        


        // Eligibility
        const eligibilityResult = document.getElementById('eligibilityResult');
        const eligibilityStatus = document.getElementById('eligibilityStatus');
        const eligibilityReason = document.getElementById('eligibilityReason');
        
        if (scanData.eligible) {
          eligibilityResult.className = 'eligibility-result';
          eligibilityStatus.textContent = 'Eligible for tPA Treatment';
          eligibilityStatus.className = 'eligibility-status eligible';
          eligibilityReason.textContent = scanData.eligibility_result || 'Meets all criteria for tPA administration';
        } else {
          eligibilityResult.className = 'eligibility-result not-eligible';
          eligibilityStatus.textContent = 'Not Eligible for tPA Treatment';
          eligibilityStatus.className = 'eligibility-status not-eligible';
          eligibilityReason.textContent = scanData.eligibility_result || 'Does not meet criteria for tPA administration';
        }
        
        // Technician notes
        document.getElementById('technicianNotes').value = scanData.technician_notes || 'No notes provided';
        
        // Doctor comment
        
      } else {
        document.getElementById('scanFileName').textContent = 'No scan data available';
        document.getElementById('scanUploadDate').textContent = 'N/A';
        document.getElementById('technicianNotes').value = 'No scan data available';
      }
    }

    // Populate vitals table
    function populateVitalsTable(patientData) {

      function assessVital(name, value, secondValue = null) {
        let status = "Normal";

        switch (name) {

          case "Blood Pressure":
            const sys = value;            // first number
            const dia = secondValue;      // second number

            if (sys > 185 || dia > 110) status = "Critical";
            else if (sys > 140 || dia > 90) status = "High";
            else if (sys < 90 || dia < 60) status = "Low";
            else status = "Normal";
            break;

          case "Heart Rate":
            if (value > 120) status = "High";
            else if (value < 50) status = "Low";
            else status = "Normal";
            break;

          case "Oxygen Saturation":
            if (value < 90) status = "Critical";
            else if (value < 94) status = "Low";
            else status = "Normal";
            break;

          case "Temperature":
            if (value > 103) status = "Critical";
            else if (value > 100.4) status = "High"; // fever
            else if (value < 95) status = "Low";     // hypothermia
            else status = "Normal";
            break;

          case "Glucose":
            if (value > 400) status = "Critical";
            else if (value > 180) status = "High";
            else if (value < 70) status = "Low";
            else status = "Normal";
            break;

          case "INR":
            if (value > 3.0) status = "High";
            else if (value < 0.9) status = "Low";
            else status = "Normal";
            break;

          case "Platelet Count":
            if (value < 100) status = "Critical";      // too low for tPA
            else if (value < 150) status = "Low";
            else if (value > 450) status = "High";
            else status = "Normal";
            break;
        }

        return status;
      }

      // Build vitals list with status calculation
      const vitals = [
        {
          name: "Blood Pressure",
          value: `${patientData.systolic_bp}/${patientData.diastolic_bp}`,
          unit: "mmHg",
          status: assessVital("Blood Pressure", patientData.systolic_bp, patientData.diastolic_bp)
        },
        {
          name: "Heart Rate",
          value: patientData.heart_rate,
          unit: "bpm",
          status: assessVital("Heart Rate", patientData.heart_rate)
        },
        {
          name: "Oxygen Saturation",
          value: patientData.oxygen_saturation,
          unit: "%",
          status: assessVital("Oxygen Saturation", patientData.oxygen_saturation)
        },
        {
          name: "Temperature",
          value: patientData.temperature,
          unit: "¬∞F",
          status: assessVital("Temperature", patientData.temperature)
        },
        {
          name: "Glucose",
          value: patientData.glucose,
          unit: "mg/dL",
          status: assessVital("Glucose", patientData.glucose)
        },
        {
          name: "INR",
          value: patientData.inr,
          unit: "",
          status: assessVital("INR", patientData.inr)
        },
        {
          name: "Platelet Count",
          value: patientData.platelet_count,
          unit: "/ŒºL",
          status: assessVital("Platelet Count", patientData.platelet_count)
        }
      ];

      const tbody = document.getElementById("vitalsTableBody");

      tbody.innerHTML = vitals
        .map(vital => `
          <tr>
            <td>${vital.name}</td>
            <td>${vital.value}</td>
            <td>${vital.unit}</td>
            <td style="font-weight: bold; color: ${
              vital.status === "Critical" ? "#F44336" :
              vital.status === "High" ? "#FF9800" :
              vital.status === "Low" ? "#2196F3" :
              "#4CAF50"
            }">
              ${vital.status}
            </td>
          </tr>
        `)
        .join("");
    }


    // Populate NIHSS scores
    function populateNIHSS(nihssData) {
      const nihssScores = [
        { label: 'Consciousness', score: nihssData.consciousness },
        { label: 'Gaze', score: nihssData.gaze },
        { label: 'Visual', score: nihssData.visual },
        { label: 'Facial', score: nihssData.facial },
        { label: 'Motor Arm Left', score: nihssData.motor_arm_left },
        { label: 'Motor Arm Right', score: nihssData.motor_arm_right },
        { label: 'Motor Leg Left', score: nihssData.motor_leg_left },
        { label: 'Motor Leg Right', score: nihssData.motor_leg_right },
        { label: 'Ataxia', score: nihssData.ataxia },
        { label: 'Sensory', score: nihssData.sensory },
        { label: 'Language', score: nihssData.language },
        { label: 'Dysarthria', score: nihssData.dysarthria },
        { label: 'Extinction', score: nihssData.extinction }
      ];
      
      const grid = document.getElementById('nihssGrid');
      grid.innerHTML = nihssScores.map(item => `
        <div class="nihss-item">
          <div class="nihss-label">${item.label}</div>
          <div class="nihss-score">${item.score}</div>
        </div>
      `).join('');
      
      // Total score and severity
      const total = nihssData.total_score || 0;
      document.getElementById('nihssTotal').textContent = total;
      
      let severity = '';
      if (total <= 4) severity = 'Minor Stroke';
      else if (total <= 15) severity = 'Moderate Stroke';
      else if (total <= 20) severity = 'Moderate to Severe Stroke';
      else severity = 'Severe Stroke';
      
      document.getElementById('nihssSeverity').textContent = severity;
    }

    // Show error message
    function showError(message) {
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('errorText').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
    }
    
    // Select ICD code
    async function searchICD10(query) {
    const resultsContainer = document.getElementById('icdResults');

    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    resultsContainer.innerHTML = '<div class="icd-loading">Searching ICD-10...</div>';
    resultsContainer.style.display = 'block';

    try {
        const response = await fetch(
            `https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms=${encodeURIComponent(query)}`
        );

        const data = await response.json();

        const codes = data[1];        // list of ICD codes
        const items = data[3];        // list of [code, description]

        if (!codes || !items || codes.length === 0) {
            resultsContainer.innerHTML = '<div class="icd-error">No results found</div>';
            return;
        }

        let html = "";
        for (let i = 0; i < items.length; i++) {
            const code = items[i][0];
            const desc = items[i][1];

            html += `
                <div class="icd-result-item"
                    onclick="selectICDCode('${code}', '${desc.replace(/'/g, "\\'")}')">
                    <div class="icd-code">${code}</div>
                    <div class="icd-description">${desc}</div>
                </div>
            `;
        }

        resultsContainer.innerHTML = html;

    } catch (err) {
        console.error("ICD fetch error:", err);
        resultsContainer.innerHTML = '<div class="icd-error">Error fetching ICD data</div>';
    }
}


    function selectICDCode(code, description) {
    selectedICDCode = { code, description };

    // Show formatted result in input
    document.getElementById("icdSearchInput").value = `${code} - ${description}`;

    // Hide dropdown results
    document.getElementById("icdResults").style.display = "none";

    // Update the visible selected diagnosis box
    document.getElementById("selectedDiagnosis").textContent = `${code} - ${description}`;
    document.getElementById("selectedDiagnosisContainer").style.display = "block";
}



    // Save doctor comment
    async function saveDoctorComment() {
      const comment = document.getElementById('doctorComment').value;
      
      if (!currentScanId) {
        alert('No scan ID available');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('comment', comment);
        
        const response = await fetch(`/scans/${currentScanId}/comment`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          alert('Comment saved successfully');
        } else {
          alert('Failed to save comment');
        }
      } catch (error) {
        console.error('Error saving comment:', error);
        alert('Error saving comment');
      }
    }

    // Save diagnosis and treatment
    async function saveDiagnosis() {
      if (!selectedICDCode) {
        alert('Please select an ICD-10 diagnosis first');
        return;
      }
      
      const treatmentPlan = document.getElementById('treatmentPlan').value;
      
      if (!treatmentPlan.trim()) {
        alert('Please enter a treatment plan');
        return;
      }
      
      // This would be implemented with a backend endpoint
      alert('Diagnosis and treatment plan saved successfully');
    }

    // Make decision
  async function makeDecision(status) {
  if (!currentScanId) {
    alert('No scan ID available');
    return;
  }

  // Get doctor comment text
  

  let confirmMessage = '';
  switch (status) {
    case 'approved_tpa':
      confirmMessage = 'Are you sure you want to approve tPA treatment for this patient?';
      break;
    case 'rejected':
      confirmMessage = 'Are you sure you want to reject this case?';
      break;
    case 'sent_to_doctor':
      confirmMessage = 'Are you sure you want to request an update for this case?';
      break;
  }

  if (!confirm(confirmMessage)) {
    return;
  }

  // Convert button status ‚Üí backend decision value
  const decisionValue = status === "approved_tpa" ? "eligible" : "not_eligible";

  try {
    const response = await fetch(`/api/scans/${currentScanId}/decision`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        decision: decisionValue,
      })
    });

    if (response.ok) {
      alert("Decision recorded successfully. Technician and patient have been notified.");

      // Optional redirect
      setTimeout(() => {
        window.location.href = "/physician-dashboard";
      }, 2000);
    } else {
      const err = await response.json().catch(() => ({}));
      alert("Failed to record decision: " + (err.detail || ""));
    }
  } catch (error) {
    console.error("Error making decision:", error);
    alert("Error recording decision");
  }
}

    // Close ICD results when clicking outside
    document.addEventListener('click', function(event) {
      const icdContainer = document.querySelector('.icd-search-container');
      const icdResults = document.getElementById('icdResults');
      
      if (!icdContainer.contains(event.target)) {
        icdResults.style.display = 'none';
      }
    });

    // Toast Notification System
    function showToast(message, type = 'info', duration = 5000) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="removeToast(this)">√ó</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto-remove after duration
      setTimeout(() => removeToast(toast.querySelector('.toast-close')), duration);
    }
    
    function removeToast(closeBtn) {
      const toast = closeBtn.closest('.toast');
      if (toast) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }
    }

    // AI Treatment Generator Functions
    async function generateAITreatmentPlan() {
      const generateBtn = document.getElementById('generatePlanBtn');
      const generateBtnText = document.getElementById('generateBtnText');
      const generateBtnSpinner = document.getElementById('generateBtnSpinner');
      const loadingMessage = document.getElementById('aiLoadingMessage');
      const saveBtn = document.getElementById('savePlanBtn');
      
      // Show loading state
      generateBtn.disabled = true;
      generateBtnText.style.display = 'none';
      generateBtnSpinner.style.display = 'inline-block';
      loadingMessage.style.display = 'flex';
      
      try {
        // Collect patient data from the page
        const patientData = collectPatientDataForAI();
        
        // Validate patient data
        if (!validatePatientData(patientData)) {
          throw new Error('Incomplete patient data. Please ensure all required information is available.');
        }
        
        showToast('Sending request to AI...', 'info', 2000);
        
        // Call the AI treatment generation endpoint
        const response = await fetch('/api/generate-treatment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(patientData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: 'Unknown error occurred' }));
          throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.treatment_plan) {
          // Display the generated treatment plan
          const treatmentPlanTextarea = document.getElementById('treatmentPlan');
          treatmentPlanTextarea.value = data.treatment_plan;
          
          // Show save button
          saveBtn.style.display = 'inline-block';
          
          // Show success toast
          showToast('AI treatment plan generated successfully!', 'success', 4000);
          
          // Hide loading message after a brief delay
          setTimeout(() => {
            loadingMessage.style.display = 'none';
          }, 1000);
          
        } else {
          throw new Error('No treatment plan received from AI service');
        }
        
      } catch (error) {
        console.error('Error generating AI treatment plan:', error);
        
        // Hide loading state
        loadingMessage.style.display = 'none';
        
        // Show error toast
        let errorMessage = 'Failed to generate treatment plan';
        
        if (error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your internet connection.';
        } else if (error.message.includes('timeout')) {
          errorMessage = 'Request timed out. Please try again.';
        } else if (error.message.includes('API key')) {
          errorMessage = 'AI service configuration error. Please contact support.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error', 6000);
        
      } finally {
        // Re-enable button
        generateBtn.disabled = false;
        generateBtnText.style.display = 'inline';
        generateBtnSpinner.style.display = 'none';
      }
    }
    
    function validatePatientData(patientData) {
      const requiredFields = ['name', 'age', 'nhiss_score', 'systolic_bp', 'diastolic_bp', 'glucose', 'oxygen_saturation', 'symptoms'];
      
      for (const field of requiredFields) {
        if (!patientData[field] || patientData[field] === 0) {
          console.warn(`Missing or invalid field: ${field}`, patientData[field]);
          return false;
        }
      }
      
      // Additional validation
      if (patientData.age < 1 || patientData.age > 120) {
        console.warn('Invalid age:', patientData.age);
        return false;
      }
      
      if (patientData.nhiss_score < 0 || patientData.nhiss_score > 42) {
        console.warn('Invalid NIHSS score:', patientData.nhiss_score);
        return false;
      }
      
      return true;
    }
    
    function collectPatientDataForAI() {
      // Extract patient data from the page elements
      const patientName = document.getElementById('patientName').textContent || 'Unknown Patient';
      const patientAge = parseInt(document.getElementById('patientAge').textContent) || 0;
      const chiefComplaint = document.getElementById('chiefComplaint').textContent || 'Not specified';
      
      // Extract NIHSS score
      const nihssTotal = document.getElementById('nihssTotal').textContent;
      const nhissScore = parseInt(nihssTotal) || 0;
      
      // Extract vitals from the table
      const vitalsRows = document.querySelectorAll('#vitalsTableBody tr');
      let systolicBp = 120, diastolicBp = 80, glucose = 100, oxygenSaturation = 98;
      
      vitalsRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const parameter = cells[0].textContent.toLowerCase();
          const value = cells[1].textContent;
          
          if (parameter.includes('blood pressure')) {
            const bpMatch = value.match(/(\d+)\/(\d+)/);
            if (bpMatch) {
              systolicBp = parseInt(bpMatch[1]);
              diastolicBp = parseInt(bpMatch[2]);
            }
          } else if (parameter.includes('glucose')) {
            const glucoseMatch = value.match(/(\d+)/);
            if (glucoseMatch) {
              glucose = parseInt(glucoseMatch[1]);
            }
          } else if (parameter.includes('oxygen saturation')) {
            const oxygenMatch = value.match(/(\d+)/);
            if (oxygenMatch) {
              oxygenSaturation = parseInt(oxygenMatch[1]);
            }
          }
        }
      });
      
      // Create symptoms description from available data
      const symptoms = [
        chiefComplaint,
        `NIHSS Score: ${nhissScore}`,
        `Blood Pressure: ${systolicBp}/${diastolicBp} mmHg`,
        `Glucose: ${glucose} mg/dL`,
        `Oxygen Saturation: ${oxygenSaturation}%`
      ].join('. ');
      
      return {
        name: patientName,
        age: patientAge,
        nhiss_score: nhissScore,
        systolic_bp: systolicBp,
        diastolic_bp: diastolicBp,
        glucose: glucose,
        oxygen_saturation: oxygenSaturation,
        symptoms: symptoms
      };
    }
    
    async function saveAITreatmentPlan() {
      const treatmentPlan = document.getElementById('treatmentPlan').value;
      const saveBtn = document.getElementById('savePlanBtn');
      
      if (!treatmentPlan.trim()) {
        showToast('Please generate a treatment plan first', 'warning', 4000);
        return;
      }
      
      if (!currentPatientCode) {
        showToast('No patient code available', 'error', 4000);
        return;
      }
      
      // Show loading state on save button
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
      
      try {
        showToast('Saving treatment plan...', 'info', 2000);
        
        // Use the existing diagnosis endpoint to save the treatment plan
        const response = await fetch(`/physician/cases/${currentPatientCode}/diagnosis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            treatment_plan: treatmentPlan,
            diagnosis: selectedICDCode ? selectedICDCode.code : 'AI-Generated Treatment Plan',
            notes: 'AI-generated treatment plan'
          })
        });
        
        if (response.ok) {
          showToast('Treatment plan saved successfully!', 'success', 4000);
          saveBtn.style.display = 'none';
        } else {
          const errorData = await response.json().catch(() => ({ detail: 'Unknown error occurred' }));
          throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }
        
      } catch (error) {
        console.error('Error saving treatment plan:', error);
        
        let errorMessage = 'Failed to save treatment plan';
        if (error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your connection.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error', 6000);
        
      } finally {
        // Restore button state
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    }
  </script>
</body>
</html>
